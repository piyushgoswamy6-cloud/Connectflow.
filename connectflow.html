<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConnectFlow - Secure Comms</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; touch-action: manipulation; }
        .screen { display: none; }
        .screen.active { display: block; }
        .video-participant-container { aspect-ratio: 16 / 9; position: relative; background-color: #1a202c; border-radius: 0.5rem; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .participant-name { position: absolute; bottom: 0; left: 0; background: rgba(0,0,0,0.5); padding: 0.25rem 0.5rem; margin: 0.5rem; border-radius: 0.25rem; }
        /* Custom scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen antialiased">

    <!-- Main Container -->
    <div id="app-container" class="w-full h-screen">

        <!-- Login Screen -->
        <div id="login-screen" class="screen active flex items-center justify-center h-full p-4">
            <div class="w-full max-w-sm flex-col space-y-6 bg-gray-800 p-8 rounded-xl shadow-2xl">
                <h1 class="text-3xl font-bold text-center text-indigo-400">ConnectFlow Secure</h1>
                <p class="text-center text-gray-400 text-sm">Please log in to continue.</p>
                <div class="space-y-4">
                    <input type="text" id="user-id-input" placeholder="User ID" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-400">
                    <input type="password" id="pin-input" placeholder="PIN" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-400">
                </div>
                <button id="login-button" class="w-full py-3 px-4 bg-indigo-600 hover:bg-indigo-700 rounded-md text-lg font-semibold transition-all">Login</button>
                <p id="login-error" class="text-center text-red-400 text-sm h-4"></p>
            </div>
        </div>

        <!-- User Dialer Screen -->
        <div id="dialer-screen" class="screen flex items-center justify-center h-full p-4">
            <div class="w-full max-w-lg flex-col p-8 space-y-6 bg-gray-800 rounded-xl shadow-2xl">
                 <div class="flex justify-between items-center">
                    <h1 id="welcome-name" class="text-2xl font-bold text-indigo-400"></h1>
                    <button id="logout-button" class="text-sm text-gray-400 hover:text-white">Logout</button>
                </div>
                <div class="p-4 bg-gray-700 rounded-lg text-center">
                    <p class="text-sm text-gray-400">Your User ID</p>
                    <p id="my-user-id" class="text-2xl font-semibold tracking-widest"></p>
                </div>
                <div class="relative w-full aspect-video bg-black rounded-lg overflow-hidden">
                    <video id="home-video" autoplay playsinline muted></video>
                </div>
                <div class="space-y-4">
                     <input type="number" id="call-number-input" placeholder="Enter User ID to call" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md">
                     <button id="call-button" class="w-full py-3 px-4 bg-indigo-600 hover:bg-indigo-700 rounded-md text-lg font-semibold flex items-center justify-center space-x-2">
                        <span>Call</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- In-Call Screen -->
        <div id="call-screen" class="screen h-full flex flex-col p-4">
            <div id="video-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4 flex-1 w-full"></div>
            <footer class="py-4 mt-4 text-center">
                 <button id="end-call-button" class="p-4 bg-red-600 rounded-full hover:bg-red-700 transform scale-110">
                     <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M16 8l2-2m0 0l2 2m-2-2v10a2 2 0 01-2 2H8a2 2 0 01-2-2V6m0 0L6 8m0-2l2-2m0 0l2 2"></path></svg>
                 </button>
            </footer>
        </div>

        <!-- Admin Dashboard Screen -->
        <div id="admin-dashboard-screen" class="screen h-full flex flex-col p-4 md:p-8">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-indigo-400">Admin Dashboard</h1>
                <button id="admin-logout-button" class="text-sm text-gray-400 hover:text-white">Logout</button>
            </div>
            
            <div class="flex-1 grid grid-cols-1 lg:grid-cols-2 gap-8 overflow-hidden">
                <!-- User Management -->
                <div class="flex flex-col bg-gray-800 p-6 rounded-xl shadow-2xl">
                    <h2 class="text-xl font-semibold mb-4">User Management</h2>
                    <div id="user-list-container" class="flex-1 overflow-y-auto custom-scrollbar pr-2">
                        <!-- User list will be populated here -->
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-700">
                        <h3 class="font-semibold mb-2">Add New User</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                             <input type="text" id="new-user-name" placeholder="Full Name" class="px-3 py-2 bg-gray-700 rounded-md">
                             <input type="password" id="new-user-pin" placeholder="4-Digit PIN" class="px-3 py-2 bg-gray-700 rounded-md" maxlength="4">
                        </div>
                        <button id="add-user-button" class="w-full mt-2 py-2 px-4 bg-indigo-600 hover:bg-indigo-700 rounded-md">Add User</button>
                    </div>
                </div>

                <!-- Call Recordings -->
                <div class="flex flex-col bg-gray-800 p-6 rounded-xl shadow-2xl">
                    <h2 class="text-xl font-semibold mb-4">Call Recordings</h2>
                    <div id="recording-list-container" class="flex-1 overflow-y-auto custom-scrollbar pr-2">
                         <p class="text-gray-400">No recordings yet.</p>
                        <!-- Recording list will be populated here -->
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Recording Viewer Modal -->
    <div id="recording-viewer-modal" class="fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4" style="display: none;">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-3xl flex-col space-y-4">
             <div class="flex justify-between items-center">
                <h3 id="recording-modal-title" class="text-lg font-bold">Call Recording</h3>
                <button id="close-modal-button" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <video id="recording-video-player" class="w-full rounded-lg" controls></video>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- IN-MEMORY DATABASE (Resets on page refresh) ---
        // NOTE: In a real app, this data would live on a secure server.
        let DB = {
            // Hardcoded Admin Account
            ADMIN_ACCOUNT: { id: "admin", pin: "0000" },
            
            USER_ACCOUNTS: {
                "1112223333": { name: "Alice", pin: "1234" },
                "4445556666": { name: "Bob", pin: "5678" },
            },
            
            CALL_RECORDINGS: []
        };

        // --- State Variables ---
        let localStream;
        let currentUser = null;
        let mediaRecorder;
        let recordedChunks = [];
        let callStartTime;

        // --- DOM Elements ---
        const screens = Object.fromEntries(Array.from(document.querySelectorAll('.screen')).map(el => [el.id.replace('-screen', ''), el]));
        const loginError = document.getElementById('login-error');

        // --- App Logic ---
        const showScreen = (screenName) => {
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            if (screens[screenName]) screens[screenName].classList.add('active');
        };

        const handleLogin = () => {
            const userId = document.getElementById('user-id-input').value.trim();
            const pin = document.getElementById('pin-input').value.trim();
            loginError.textContent = '';

            if (userId === DB.ADMIN_ACCOUNT.id && pin === DB.ADMIN_ACCOUNT.pin) {
                currentUser = { id: 'admin', name: 'Admin' };
                setupAdminDashboard();
            } else if (DB.USER_ACCOUNTS[userId] && DB.USER_ACCOUNTS[userId].pin === pin) {
                currentUser = { id: userId, ...DB.USER_ACCOUNTS[userId] };
                setupDialerScreen();
            } else {
                loginError.textContent = 'Invalid credentials.';
            }
        };

        const handleLogout = () => {
            if (localStream) localStream.getTracks().forEach(track => track.stop());
            localStream = null;
            currentUser = null;
            document.getElementById('user-id-input').value = '';
            document.getElementById('pin-input').value = '';
            showScreen('login');
        };
        
        // --- USER-FACING FUNCTIONS ---
        const setupDialerScreen = async () => {
            showScreen('dialer');
            document.getElementById('welcome-name').textContent = `Welcome, ${currentUser.name}`;
            document.getElementById('my-user-id').textContent = currentUser.id.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('home-video').srcObject = localStream;
            } catch (err) { handleLogout(); }
        };
        
        const startCall = () => {
            const numberToCall = document.getElementById('call-number-input').value.replace(/\D/g,'');
            if (!DB.USER_ACCOUNTS[numberToCall] || numberToCall === currentUser.id) {
                alert("Invalid or own User ID.");
                return;
            }
            showScreen('call');
            const partner = { id: numberToCall, ...DB.USER_ACCOUNTS[numberToCall] };
            setupCallUI(partner);
            startHiddenRecording(partner);
        };
        
        const setupCallUI = (partner) => {
            const videoGrid = document.getElementById('video-grid');
            videoGrid.innerHTML = '';
            addParticipant(localStream, `${currentUser.name} (You)`);
            addParticipant(localStream, partner.name); // SIMULATION
        };

        const addParticipant = (stream, name) => {
            const videoGrid = document.getElementById('video-grid');
            const container = document.createElement('div');
            container.className = 'video-participant-container';
            const video = document.createElement('video');
            video.autoplay = true;
            video.playsInline = true;
            video.srcObject = stream;
            if (name.includes('(You)')) video.muted = true;
            container.append(video);
            const nameTag = document.createElement('div');
            nameTag.className = 'participant-name';
            nameTag.textContent = name;
            container.append(nameTag);
            videoGrid.append(container);
        };

        const endCall = () => {
            stopHiddenRecording();
            setupDialerScreen();
        };

        // --- ADMIN DASHBOARD FUNCTIONS ---
        const setupAdminDashboard = () => {
            showScreen('admin');
            renderUserList();
            renderRecordingsList();
        };

        const renderUserList = () => {
            const container = document.getElementById('user-list-container');
            container.innerHTML = '';
            Object.entries(DB.USER_ACCOUNTS).forEach(([id, user]) => {
                const userEl = document.createElement('div');
                userEl.className = 'flex justify-between items-center bg-gray-700 p-2 rounded-md mb-2';
                userEl.innerHTML = `
                    <div>
                        <p class="font-semibold">${user.name}</p>
                        <p class="text-xs text-gray-400">${id}</p>
                    </div>
                    <button data-id="${id}" class="delete-user-btn text-red-400 hover:text-red-300">&times;</button>
                `;
                container.appendChild(userEl);
            });
        };
        
        const addNewUser = () => {
            const name = document.getElementById('new-user-name').value.trim();
            const pin = document.getElementById('new-user-pin').value.trim();
            if (!name || !/^\d{4}$/.test(pin)) {
                alert('Please enter a valid name and 4-digit PIN.');
                return;
            }
            const newId = (Math.floor(1000000000 + Math.random() * 9000000000)).toString();
            DB.USER_ACCOUNTS[newId] = { name, pin };
            renderUserList();
            document.getElementById('new-user-name').value = '';
            document.getElementById('new-user-pin').value = '';
        };

        const deleteUser = (userId) => {
            if (confirm(`Are you sure you want to delete user ${userId}?`)) {
                delete DB.USER_ACCOUNTS[userId];
                renderUserList();
            }
        };
        
        const renderRecordingsList = () => {
            const container = document.getElementById('recording-list-container');
            container.innerHTML = '';
            if (DB.CALL_RECORDINGS.length === 0) {
                 container.innerHTML = `<p class="text-gray-400">No recordings yet.</p>`;
                 return;
            }
            [...DB.CALL_RECORDINGS].reverse().forEach(rec => {
                const recEl = document.createElement('div');
                recEl.className = 'bg-gray-700 p-3 rounded-md mb-2';
                recEl.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                             <p class="font-semibold text-sm">${rec.participants}</p>
                             <p class="text-xs text-gray-400">${rec.date} (${rec.duration}s)</p>
                        </div>
                        <button data-id="${rec.id}" class="view-rec-btn py-1 px-3 bg-indigo-600 rounded-md text-sm">View</button>
                    </div>
                `;
                container.appendChild(recEl);
            });
        };

        // --- RECORDING LOGIC ---
        const startHiddenRecording = (partner) => {
            if (localStream && window.MediaRecorder) {
                recordedChunks = [];
                const options = { mimeType: 'video/webm;codecs=vp9' };
                mediaRecorder = new MediaRecorder(localStream, options);
                mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const blobUrl = URL.createObjectURL(blob);
                    const duration = Math.round((Date.now() - callStartTime) / 1000);
                    DB.CALL_RECORDINGS.push({
                        id: `rec-${Date.now()}`,
                        participants: `${currentUser.name} & ${partner.name}`,
                        date: new Date().toLocaleString(),
                        duration: duration,
                        blobUrl: blobUrl
                    });
                };
                callStartTime = Date.now();
                mediaRecorder.start();
            }
        };

        const stopHiddenRecording = () => {
            if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
        };

        const viewRecording = (recId) => {
            const recording = DB.CALL_RECORDINGS.find(r => r.id === recId);
            if (!recording) return;
            document.getElementById('recording-modal-title').textContent = `Recording: ${recording.participants}`;
            document.getElementById('recording-video-player').src = recording.blobUrl;
            document.getElementById('recording-viewer-modal').style.display = 'flex';
        };
        
        // --- Event Listeners ---
        document.getElementById('login-button').addEventListener('click', handleLogin);
        document.getElementById('logout-button').addEventListener('click', handleLogout);
        document.getElementById('admin-logout-button').addEventListener('click', handleLogout);
        document.getElementById('call-button').addEventListener('click', startCall);
        document.getElementById('end-call-button').addEventListener('click', endCall);
        document.getElementById('add-user-button').addEventListener('click', addNewUser);
        document.getElementById('close-modal-button').addEventListener('click', () => {
            document.getElementById('recording-viewer-modal').style.display = 'none';
            document.getElementById('recording-video-player').pause();
            document.getElementById('recording-video-player').src = '';
        });

        // Event delegation for dynamic lists
        document.body.addEventListener('click', (e) => {
            if (e.target.matches('.delete-user-btn')) deleteUser(e.target.dataset.id);
            if (e.target.matches('.view-rec-btn')) viewRecording(e.target.dataset.id);
        });

        // --- Initial Load ---
        showScreen('login');
    });
    </script>
</body>
</html>


